name = "thought-capture"
main = "src/index.ts"
compatibility_date = "2026-02-16"
compatibility_flags = ["nodejs_compat"]
routes = [
  { pattern = "bt.tylerevans.co", custom_domain = true }
]

[vars]
THOUGHT_CAPTURE_V1_ENABLED = "true"
ENABLED_USER_IDS = ""

[[d1_databases]]
binding = "DB"
database_name = "thought-capture-db"
database_id = "local-dev-placeholder"
migrations_dir = "migrations"

[[queues.producers]]
queue = "thought-classification"
binding = "CLASSIFICATION_QUEUE"

[[queues.producers]]
queue = "digest-delivery"
binding = "DIGEST_DELIVERY_QUEUE"

[[queues.consumers]]
queue = "thought-classification"
max_batch_size = 1
max_retries = 3
dead_letter_queue = "thought-classification-dlq"

[[queues.consumers]]
queue = "digest-delivery"
max_batch_size = 5
max_retries = 3
dead_letter_queue = "digest-delivery-dlq"

[triggers]
crons = ["*/15 * * * *", "0 3 * * *", "*/5 * * * *"]
# */15 * * * *  = digest scheduler (every 15 min)
# 0 3 * * *    = TTL cleanup (daily at 03:00 UTC)
# */5 * * * *  = classification catch-up (every 5 min)

[env.staging]
routes = [
  { pattern = "bt-stg.tylerevans.co", custom_domain = true }
]
